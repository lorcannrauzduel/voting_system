<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VotingSystem | Accueil</title>
    
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css" rel="stylesheet"/>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&display=swap" rel="stylesheet"/>

    <!-- MDB -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/mdb-ui-kit/3.3.0/mdb.min.css" rel="stylesheet"/>

    <!-- Notify -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-notify/0.2.0/css/bootstrap-notify.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-notify/0.2.0/css/styles/alert-bangtidy.min.css">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="#"><img src="https://reeseville.com/wp-content/uploads/2020/09/ballot-box.png" alt="" width="50px" height="50px"> <strong>Voting</strong>System</a>
            <button
            class="navbar-toggler"
            type="button"
            data-mdb-toggle="collapse"
            data-mdb-target="#navbarNav"
            aria-controls="navbarNav"
            aria-expanded="false"
            aria-label="Toggle navigation"
          >
            <i class="fas fa-bars"></i>
          </button>
          <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav">
                <% if(isOwner) { %>
                <li class="nav-item">
                    <a class="nav-link active" aria-current="page" href="/admin">Admin</a>
                </li>
                <% } %>
            </ul>
          </div>
        </div>
      </nav>
    <div class="container">
        <div class="d-flex justify-content-center mt-5 mb-5">
            <button class="btn btn-light btn-rounded"> <%= workflow %></button>
        </div>
        <ul class="nav nav-tabs nav-fill" id="ex1" role="tablist">
            <li class="nav-item" role="presentation">
                <a
                    class="nav-link active"
                    id="ex3-tab-1"
                    data-mdb-toggle="pill"
                    href="#ex3-pills-1"
                    role="tab"
                    aria-controls="ex3-pills-1"
                    aria-selected="true"
                    >Propositions</a
                >
            </li>
            <li class="nav-item" role="presentation">
                <a
                    class="nav-link"
                    id="ex3-tab-2"
                    data-mdb-toggle="pill"
                    href="#ex3-pills-2"
                    role="tab"
                    aria-controls="ex3-pills-2"
                    aria-selected="false"
                    >Historique</a
                >
            </li>
        </ul>
        <div class="tab-content mt-3 mb-5" id="ex2-content">
            <div
            class="tab-pane fade show active"
            id="ex3-pills-1"
            role="tabpanel"
            aria-labelledby="ex3-tab-1"
            >
                <h2 class="mt-3">Enregistrer une proposition</h2>
                <div class="form-outline mt-3">
                    <textarea class="form-control" id="proposal-description" rows="4"></textarea>
                    <label class="form-label" for="textAreaExample">Proposition</label>
                </div>
                <button type="button" class="btn btn-primary btn-rounded mt-3" id="btn-add-proposal">
                    Ajouter
                </button>
                <div id="list-proposals">
                    <% for(var i=0; i< proposals.length; i++) { %>
                        <hr>
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title"><%= proposals[i][0] %></h5>
                                <hr>
                                <button type="button" class="alert alert-light btn-add-vote m-0 p-0" data-id="<%= i %>">
                                    <i class="fas fa-thumbs-up fa-lg"></i> <span class="badge bg-danger ms-2" id="count-vote-<%= i %>"><%= proposals[i][1] %> </span> 
                                </button>
                            </div>
                        </div>    
                    <% } %>     
                </div>
            </div>
            <div
            class="tab-pane fade mb-5"
            id="ex3-pills-2"
            role="tabpanel"
            aria-labelledby="ex3-tab-2"
            >
                <h2 class="mb-3">Historique</h2>
                <% for(var i=0; i< historical.length; i++) { %>
                    <hr>
                    <div class="card mb-4">
                        <div class="card-header text-muted"><%= historical[i].timestamp %></div>
                        <div class="card-body">
                          <h5 class="card-title"><%= historical[i].voter %> a voté</h5>
                          <p class="card-text">
                            <%= historical[i].proposal_title %>
                          </p>
                        </div>
                        <div class="card-footer text-muted">Tx : <%= historical[i].hash %></div>
                    </div>
                <% } %>
            </div>
        </div>
    </div>
</body>
<!-- MDB -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/mdb-ui-kit/3.3.0/mdb.min.js"></script>

<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>

<!-- Web3.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/web3/1.3.4/web3.min.js"></script>

<!-- Notify -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/notify/0.4.2/notify.min.js"></script>

<!-- Script page -->
<script>
        $(document).ready(function() {

            const owner = <%- owner %>;
            const rpc_server = "<%- rpcServer %>";
            const contract_address = "<%- contractAddress %>";
            const abi = <%- JSON.stringify(abi) %>;
            const historical = <%- JSON.stringify(historical) %>;
            const web3 = new Web3(new Web3.providers.WebsocketProvider(rpc_server));
            const contractInstance = new web3.eth.Contract(abi, contract_address);
            let account;

            ethereum.enable()
            .then(function (accounts) {
                account = accounts[0];
            })

            // Ajouter une proposition
            $('#btn-add-proposal').click(function() {
            let description = $('#proposal-description').val();
            $.ajax({
                url:"proposal",
                type: "POST",
                data: {
                    from: account,
                    description: description
                },
                dataType: "json"
            }).always(function(result) {
                console.log(result)
                if(result.success !== true) {
                    $.notify(result.message, 'error');
                } else {
                    $.notify(result.message, 'success');
                }
                })
            })

            // Voter une proposition
            $('.btn-add-vote').click(function() {
                let proposalId = $(this).attr('data-id')
                console.log(proposalId);
                $.ajax({
                    url:"vote",
                    type: "POST",
                    data: {
                        from: account,
                        proposalId: proposalId
                    },
                    dataType: "json"
                }).always(function(result) {
                    // console.log(result)
                    if(result.success !== true) {
                        $.notify(result.message, 'error');
                    } else {
                        // $.notify(result.message, 'success');
                    }
                })
            })

            // Event proposition
            contractInstance.events.ProposalRegistered()
            .on('data', async function(event){
                let proposal_id = event.returnValues.proposalId;
                contractInstance.methods.getProposal(proposal_id).call().then(function(proposal) { 
                    let html = '<div class="card"><div class="card-body"><h5 class="card-title">'+proposal[0]+'</h5><div></div><button type="button" class="btn btn-primary btn-add-vote mt-1" data-id="'+proposal_id+'"><i class="fas fa-thumbs-up"></i><span class="badge bg-danger ms-2" id="count-vote-'+proposal_id+'">'+proposal[1]+'</span></button></div></div>'
                    $('#list-proposals').prepend(html)
                });
            })
            .on('error', console.error);

            // Event vote
            contractInstance.events.Voted()
            .on('data', async function(event){
                let proposal_id = event.returnValues.proposalId;
                let voter = event.returnValues.voter;
                contractInstance.methods.getProposal(event.returnValues.proposalId).call().then(function(proposal) { 
                    let count = proposal[1];
                    $('#count-vote-'+proposal_id).html(count);
                    $.notify(voter + ' a voté pour : ' + proposal[0], 'success')
                    // console.log(proposal)
                });
            })
            .on('error', console.error);

            // Event démarrage session enregistrement proposition
            contractInstance.events.ProposalsRegistrationStarted()
            .on('data', async function(event){
                $.notify('Démarrage de la session d\'enregistrement des propositions', 'success');
            })
            .on('error', console.error);

            // Event démarrage session vote
            contractInstance.events.VotingSessionStarted()
            .on('data', async function(event){
                $.notify('Démarrage de la session de vote', 'success');
            })
            .on('error', console.error);

            // Event fin session enregistrement proposition
            contractInstance.events.ProposalsRegistrationEnded()
            .on('data', async function(event){
                $.notify('Fin de la session d\'enregistrement des propositions', 'success');
            })
            .on('error', console.error);

            // Event fin de la session de vote
            contractInstance.events.VotingSessionEnded()
            .on('data', async function(event){
                $.notify('Fin de la session de vote', 'success');
            })
            .on('error', console.error);
            
        })
</script>
</html>