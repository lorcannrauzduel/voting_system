<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VotingSystem | Login</title>
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css" rel="stylesheet"/>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&display=swap" rel="stylesheet"/>
    <!-- MDB -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/mdb-ui-kit/3.3.0/mdb.min.css" rel="stylesheet"/>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
          <a class="navbar-brand" href="#">VotingSystem</a>
    </nav>
    <div class="container">
        <div class="d-flex justify-content-center mt-5 pt-5">

        <div class="card text-center" style="width: 35rem">
            <div class="card-body">
                <h5 class="card-title">Bienvenue sur notre système de vote décentralisé !</h5>
                <p class="card-text">
                    Merci de vous connectez avec votre portefeuille Metamask pour avoir accès à l'application.
                </p>            
                <button type="button" class="btn btn-info btn-rounded" id="btn-connect">Se connecter à Metamask</button>
            </div>
        </div>
        </div>
    </div>
</body>
<!-- MDB -->
<script
  src="https://cdnjs.cloudflare.com/ajax/libs/mdb-ui-kit/3.3.0/mdb.min.js"
></script>
<script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/web3/1.3.4/web3.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/notify/0.4.2/notify.min.js"></script>

<script>
        let account;
        $(document).ready(function() {
            if(!ethereum.isConnected()) {
                $('#btn-connect').click(function() {
                    ethereum.enable()
                    .then(function (accounts) {
                        account = accounts[0];
                            $.ajax({
                                url:"/login",
                                type: "POST",
                                data: {
                                    from: account,
                                },
                                dataType: "json"
                            }).always(function(result) {
                                if(result.success !== true) {
                                    $.notify(result.message, 'error');
                                } else {
                                    $.notify(result.message, 'success');
                                    window.location.href = '/home';
                                }
                            })
                    })
                    .catch(function (error) {
                        console.error(error);
                    })
                })
            } else {
                setTimeout(function() {
                    window.location.href = '/home';
                }, 2000)
            }
        })
</script>